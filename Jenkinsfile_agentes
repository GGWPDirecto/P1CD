pipeline {
    agent none

    stages {
        stage('Get Code') {
            agent any
            steps {
                sh 'echo "--- Ejecutando en: $(hostname) --- Usuario: $(whoami) ---"'
                git branch: 'develop', credentialsId: 'GitHub', url: 'https://github.com/GGWPDirecto/P1CD.git'
                
                echo "Descargando configuración de 'staging'..."
                sh 'curl -L https://raw.githubusercontent.com/GGWPDirecto/todo-list-aws-config/staging/samconfig.toml -o samconfig.toml'

                stash name: 'source', includes: '**/*'
            }
        }

        stage('Static Test') {
            agent { label 'Nodo1falke8Bandit' }
            environment {
                PATH = "/home/ubuntu/.local/bin:${env.PATH}"
            }
            steps {
                sh 'echo "--- Ejecutando en: $(hostname) --- Usuario: $(whoami) ---"'
                unstash 'source'
                sh '''
                flake8 src/ > flake8-report.txt || true
                bandit -r src/ -f txt -o bandit-report.txt || true
                '''
                archiveArtifacts artifacts: 'flake8-report.txt, bandit-report.txt', allowEmptyArchive: true
            }
        }

        stage('Deploy') {
            agent { label 'Nodo1falke8Bandit' }
            environment {
                PATH = "/home/ubuntu/.local/bin:${env.PATH}"
            }
            steps {
                sh 'echo "--- Ejecutando en: $(hostname) --- Usuario: $(whoami) ---"'
                unstash 'source'
                script {
                    sh '''
                    sam build
                    sam deploy --config-env staging
                    '''
                    def apiUrl = sh(
                        script: "aws cloudformation describe-stacks --stack-name p1cd-stack --region us-east-1 --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --output text",
                        returnStdout: true
                    ).trim()

                    if (!apiUrl) {
                        error "API_GATEWAY_URL no está definida."
                    }
                    
                    writeFile file: 'api_url.txt', text: apiUrl
                    stash name: 'apiData', includes: 'api_url.txt'
                }
            }
        }

        stage('Rest Test') {
            agent { label 'Nodo2Pytest' }
            environment {
                PATH = "/home/ubuntu/.local/bin:${env.PATH}"
            }
            steps {
                sh 'echo "--- Ejecutando en: $(hostname) --- Usuario: $(whoami) ---"'
                unstash 'source'
                unstash 'apiData'
                script {
                    def apiUrl = readFile('api_url.txt').trim()
                    env.API_GATEWAY_URL = apiUrl
                    
                    echo "Ejecutando pruebas de integración contra: ${env.API_GATEWAY_URL}"
                    sh "BASE_URL=${env.API_GATEWAY_URL} python3 -m pytest --junitxml=report.xml test/integration/todoApiTest.py || true"
                }
            }
            post {
                always {
                    junit 'report.xml'
                }
            }
        }

        stage('Promote') {
            agent { label 'Nodo2Pytest' }
            environment {
                PATH = "/home/ubuntu/.local/bin:${env.PATH}"
            }
            when {
                expression { return currentBuild.result == null || currentBuild.result == 'SUCCESS' }
            }
            steps {
                sh 'echo "--- Ejecutando en: $(hostname) --- Usuario: $(whoami) ---"'
                unstash 'source'
                script {
                    echo 'Iniciando promoción de develop a master.'
                    withCredentials([usernamePassword(credentialsId: 'GitHub', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                        sh '''
                        set +x
                        git config --global user.email "jenkins@example.com"
                        git config --global user.name "Jenkins CI"
                        git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@github.com/GGWPDirecto/P1CD.git
                        set -x

                        git checkout master
                        git fetch origin master
                        git reset --hard origin/master
                        
                        git merge --no-ff --no-commit origin/develop || true
                        
                        echo 'Restaurando el Jenkinsfile_agentes de master...'
                        git checkout HEAD -- Jenkinsfile_agentes
                        git add Jenkinsfile_agentes
                        
                        echo 'Restaurando el JENKINSFILE de master para resolver conflictos...'
                        git checkout HEAD -- JENKINSFILE
                        git add JENKINSFILE

                        git commit --allow-empty -m "Merge branch 'develop' into 'master' (CI/CD: Jenkinsfile_agentes excluido)"
                        
                        echo 'Subiendo cambios a master...'
                        git push origin master
                        '''
                    }
                    echo 'Promoción a master finalizada.'
                }
            }
        }
    }
}
