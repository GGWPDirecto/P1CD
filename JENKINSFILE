pipeline {
    agent any

    environment {
        MY_LOCAL_BIN = "/home/ubuntu/.local/bin"
        PATH = "${MY_LOCAL_BIN}:${env.PATH}"
    }

    stages {
        stage('Get Code') {
            steps {
                git branch: 'develop', credentialsId: 'GitHub', url: 'https://github.com/GGWPDirecto/P1CD.git'
            }
        }

        stage('Static Test') {
            steps {
                sh '''
                flake8 src/ > flake8-report.txt || true
                bandit -r src/ -f txt -o bandit-report.txt || true
                '''
                archiveArtifacts artifacts: 'flake8-report.txt, bandit-report.txt', allowEmptyArchive: true
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh '''
                    sam build
                    sam validate --region us-east-1

                    sam deploy --no-confirm-changeset --no-fail-on-empty-changeset \\
                      --stack-name p1cd-stack \\
                      --capabilities CAPABILITY_IAM \\
                      --s3-bucket p1cd-deploy-bucket-carlos \\
                      --region us-east-1 \\
                      --parameter-overrides Env=staging
                    '''
                    def apiUrl = sh(script: "aws cloudformation describe-stacks --stack-name p1cd-stack --region us-east-1 --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --output text", returnStdout: true).trim()
                    env.API_GATEWAY_URL = apiUrl
                    echo "API Gateway URL para Staging: ${env.API_GATEWAY_URL}"
                }
            }
        }

        stage('Rest Test') {
            steps {
                script {
                    echo "Ejecutando pruebas de integraci칩n contra: ${env.API_GATEWAY_URL}"
                    sh "BASE_URL=${env.API_GATEWAY_URL} python3 -m pytest test/integration/todoApiTest.py"
                }
            }
        }

        stage('Promote') {
            when {
                expression {
                    // Esta etapa solo se ejecuta si todas las etapas anteriores fueron exitosas.
                    return currentBuild.result == 'SUCCESS'
                }
            }
            steps {
                script {
                    echo 'Preparando merge de develop a master...'

                    sh 'git checkout master'
                    sh 'git pull origin master' 

                    def now = new Date().format("yyyy-MM-dd HH:mm:ss")
                    sh "echo \"\\n${now} - forzando cambio que active mergeo ${currentBuild.displayName} desde develop.\" >> CHANGELOG.md"
                    sh 'git add CHANGELOG.md'
                    sh 'git commit -m "creando cambio autom치tico que fuerza el mergeo ${currentBuild.displayName}"'

                 
                    echo 'Realizando merge de develop a master, manteniendo Jenkinsfile de master...'
                    sh 'git merge --no-ff develop -m "mergeado completo ; ) NICE. Build: ${currentBuild.displayName}" -X ours=Jenkinsfile'

                    // Subir los cambios a master
                    echo 'Subiendo cambios a origin master...'
                    sh 'git push origin master'
                    echo 'Merge a master completado. Versi칩n marcada para despliegue en producci칩n.LEtsssss GOOOOO'
                }
            }
        }
    }
}
