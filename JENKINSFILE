pipeline {
    agent any

    environment {
        PATH = "/home/ubuntu/.local/bin:${env.PATH}"
    }

    stages {
        stage('Get Code') {
            steps {
                git branch: 'develop', credentialsId: 'GitHub', url: 'https://github.com/GGWPDirecto/P1CD.git'
            }
        }

        stage('Static Test') {
            steps {
                sh '''
                flake8 src/ > flake8-report.txt || true
                bandit -r src/ -f txt -o bandit-report.txt || true
                '''
                archiveArtifacts artifacts: 'flake8-report.txt, bandit-report.txt', allowEmptyArchive: true
            }
        }

        stage('Deploy') {
            steps {
                script {
                    sh '''
                    sam build
                    sam validate --region us-east-1
                    sam deploy --no-confirm-changeset --no-fail-on-empty-changeset \
                      --stack-name p1cd-stack \
                      --capabilities CAPABILITY_IAM \
                      --s3-bucket p1cd-deploy-bucket-carlos \
                      --region us-east-1 \
                      --parameter-overrides Env=staging
                    '''
                    def apiUrl = sh(
                        script: "aws cloudformation describe-stacks --stack-name p1cd-stack --region us-east-1 --query 'Stacks[0].Outputs[?OutputKey==`BaseUrlApi`].OutputValue' --output text",
                        returnStdout: true
                    ).trim()

                    if (!apiUrl) {
                        error "API_GATEWAY_URL no est치 definida. Revisa el despliegue o la consulta a CloudFormation."
                    }

                    env.API_GATEWAY_URL = apiUrl
                    echo "API Gateway URL para Staging: ${env.API_GATEWAY_URL}"
                }
            }
        }

        stage('Rest Test') {
            steps {
                script {
                    echo "Ejecutando pruebas de integraci칩n contra: ${env.API_GATEWAY_URL}"
                    sh "BASE_URL=${env.API_GATEWAY_URL} python3 -m pytest test/integration/todoApiTest.py"
                }
            }
        }

        stage('Promote') {
            when {
                expression {
                    return currentBuild.result == null || currentBuild.result == 'SUCCESS'
                }
            }
            steps {
                script {
                    echo 'Iniciando promoci칩n de develop a master, excluyendo el JENKINSFILE.'

                    sh 'git checkout master'
                    sh 'git fetch origin master'
                    sh 'git reset --hard origin/master'

                    // -- Linea Corregida --
                    sh 'git merge --no-ff --no-commit develop || true'
                    
                    echo 'Restaurando el JENKINSFILE de master...'
                    sh 'git checkout HEAD -- JENKINSFILE'

                    sh 'git commit -m "Merge branch \'develop\' into \'master\' (CI/CD: JENKINSFILE excluido)"'

                    echo 'Subiendo cambios a master...'
                    withCredentials([usernamePassword(credentialsId: 'GitHub', usernameVariable: 'GIT_USER', passwordVariable: 'GIT_TOKEN')]) {
                        sh '''
                        git remote set-url origin https://${GIT_USER}:${GIT_TOKEN}@github.com/GGWPDirecto/P1CD.git
                        git push origin master
                        '''
                    }

                    echo 'Promoci칩n a master finalizada. El JENKINSFILE de master no fue modificado.'
                }
            }
        }
    }
}
